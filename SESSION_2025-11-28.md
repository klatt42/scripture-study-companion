# Development Session: 2025-11-28

## Session Overview
Fixed critical bug preventing hymns from saving to Notes page. Issue was related to Row Level Security (RLS) bypass in development mode.

---

## Problem Identified

**Issue:** Hymn Finder was showing success message "Hymn saved to your Notes!" but hymns were not actually being saved to the database.

**Error:** `new row violates row-level security policy for table "notes"`

**Root Cause:** The `createAdminClient()` function was using `createServerClient` from `@supabase/ssr`, which is designed for cookie-based authentication and doesn't properly utilize the service role key to bypass RLS policies.

---

## Solution Implemented

### 1. Fixed Admin Client (`lib/supabase/server.ts`)

**Changed from:**
```typescript
export async function createAdminClient() {
  const cookieStore = await cookies();
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    { cookies: { ... } }
  );
}
```

**Changed to:**
```typescript
export function createAdminClient() {
  // Use the raw Supabase client (not SSR) to properly utilize service role key
  return createSupabaseClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.SUPABASE_SERVICE_ROLE_KEY!,
    {
      auth: {
        persistSession: false,
        autoRefreshToken: false,
      },
    }
  );
}
```

**Key Changes:**
- Now uses `createClient` from `@supabase/supabase-js` instead of `createServerClient` from `@supabase/ssr`
- Function is no longer async (no cookie handling needed)
- Properly bypasses RLS when using service role key

### 2. Updated API Routes

**Files Modified:**
- `app/api/user-hymns/route.ts`
- `app/api/notes/route.ts`

**Pattern Applied to Both:**
```typescript
// Development mode: use admin client to bypass RLS
const isDevelopment = process.env.NODE_ENV === 'development';
const MOCK_USER_ID = '00000000-0000-0000-0000-000000000001';

export async function POST(request: Request) {
  try {
    const supabase = isDevelopment ? createAdminClient() : await createClient();

    let userId = MOCK_USER_ID;
    if (!isDevelopment) {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
      }
      userId = user.id;
    }

    // ... rest of the endpoint logic uses userId
  }
}
```

**Changes:**
- Added `createAdminClient` import
- Added development mode detection
- Use admin client in development, regular client in production
- Use mock user ID in development, real user ID in production
- Removed `await` from `createAdminClient()` calls (no longer async)

---

## Files Changed

1. **lib/supabase/server.ts**
   - Added import: `createClient as createSupabaseClient` from `@supabase/supabase-js`
   - Rewrote `createAdminClient()` to use raw Supabase client
   - Added debug logging

2. **app/api/user-hymns/route.ts**
   - Added development mode bypass logic
   - Updated GET and POST endpoints
   - Added debug console logs

3. **app/api/notes/route.ts**
   - Added development mode bypass logic
   - Updated POST, GET, and DELETE endpoints

4. **package.json & package-lock.json**
   - Dependency updates (Playwright added)

---

## Testing Results

### Local Testing (Successful)
- **Environment:** Development mode (PORT 3001)
- **Test:** Searched for hymn "On Eagles Wings" and clicked "Save to Notes"
- **Result:** âœ… Hymn successfully saved to Notes
- **Verification:** Hymn appeared on Notes page

### Server Logs Confirmed:
```
[user-hymns] NODE_ENV: development
[user-hymns] isDevelopment: true
[user-hymns] Using admin client: true
[user-hymns] User ID: 00000000-0000-0000-0000-000000000001
POST /api/user-hymns 200
```

---

## Deployment

### Git Commit
**Commit Hash:** `decc776`
**Commit Message:** "Fix hymn save to Notes: properly bypass RLS in development"

### GitHub Push
**Status:** âœ… Successfully pushed to `origin/main`
**Remote:** https://github.com/klatt42/pastoraid-genesis.git

### Vercel Deployment
**Expected URL:** https://pastoraid-genesis.vercel.app
**Status:** Deployment should auto-trigger from GitHub push
**Mode:** Production (RLS will be enforced, requires proper authentication)

---

## Environment Variables

### Required for Production (Vercel)
```
NEXT_PUBLIC_SUPABASE_URL=https://uvdywwwllsrrffaxvfra.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon key]
SUPABASE_SERVICE_ROLE_KEY=[service role key]
ANTHROPIC_API_KEY=[api key]
NODE_ENV=production
```

### Local Development (.env.local)
```
NEXT_PUBLIC_SUPABASE_URL=https://uvdywwwllsrrffaxvfra.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon key]
SUPABASE_SERVICE_ROLE_KEY=[service role key]
ANTHROPIC_API_KEY=[api key]
GOOGLE_API_KEY=[api key]
NODE_ENV=development
```

---

## Current Status

### âœ… Working Features
- Hymn Finder search (Hymnary.org integration)
- Hymn save to Notes (fixed in this session)
- Notes page (create, view, delete, export)
- Bible Search with verse ranges and translation comparison
- Sermon Ideas generator
- Sermon Outline generator
- Theology Research
- Calendar events
- Login/Signup (development bypass active)

### ðŸ”§ Development Setup
**Server Status:** Running on PORT 3001
**Development Server PIDs:**
- Background task ffe086
- Background task 523fac

**To restart dev server:**
```bash
cd ~/Developer/projects/pastoraid-genesis
PORT=3001 npm run dev
```

---

## Known Issues / Notes

1. **Production Mode:** When deployed to Vercel, the admin client bypass will NOT be active. Users will need proper authentication.

2. **Untracked Files:** `screenshot.js` is untracked (not committed)

3. **Debug Logging:** Console logs added for debugging are still active in code:
   - `lib/supabase/server.ts` - createAdminClient logs
   - `app/api/user-hymns/route.ts` - POST endpoint logs

4. **Mock User ID:** Development mode uses `00000000-0000-0000-0000-000000000001` as mock user ID

---

## Next Steps (If Continuing Development)

1. **Verify Vercel Deployment:**
   - Check https://vercel.com/dashboard for deployment status
   - Ensure all environment variables are set in Vercel
   - Test production site at https://pastoraid-genesis.vercel.app

2. **Optional Cleanup:**
   - Remove debug console.log statements if desired
   - Delete or commit `screenshot.js` file

3. **Test Production Mode:**
   - Verify authentication works in production
   - Test hymn saving with real authenticated users

4. **Monitor Errors:**
   - Check Vercel logs for any production errors
   - Verify RLS policies work correctly in production

---

## Technical Details

### Service Role Key vs Anon Key
- **Anon Key:** Used for client-side operations, enforces RLS
- **Service Role Key:** Used server-side, bypasses RLS (admin access)
- **Critical:** Service role key must NEVER be exposed to client-side code

### Why the Fix Worked
The `@supabase/ssr` package's `createServerClient` is optimized for Next.js cookie-based authentication flows. However, when using a service role key to bypass RLS, we need the raw Supabase client from `@supabase/supabase-js` which properly authenticates as the service role.

---

## Session End
**Date:** 2025-11-28
**Developer:** User (klatt42@gmail.com)
**AI Assistant:** Claude Code

All changes committed and pushed to GitHub. Ready for system reboot.
